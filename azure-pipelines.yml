trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  phpVersion: '8.3'  # Adjust as per your PHP version

steps:
# Step 1: Install PHP and required extensions
- script: |
    sudo apt-get update
    sudo apt-get install -y php${phpVersion} php${phpVersion}-fpm php${phpVersion}-mysql php${phpVersion}-mbstring php${phpVersion}-xml php${phpVersion}-curl
    sudo update-alternatives --set php /usr/bin/php${phpVersion}
    sudo update-alternatives --set php-cgi /usr/bin/php${phpVersion}
    sudo update-alternatives --set phar /usr/bin/phar${phpVersion}
    sudo update-alternatives --set phpdbg /usr/bin/phpdbg${phpVersion}
    sudo update-alternatives --set phar.phar /usr/bin/phar.phar${phpVersion}
    php -version
  displayName: 'Install PHP and required extensions'

# Step 2: Checkout the repository
- checkout: self
  displayName: 'Checkout repository'

# Step 3: Download the .env file from secure file library
- task: DownloadSecureFile@1
  name: envFile
  displayName: 'Download .env file from secure file library'
  inputs:
    secureFile: '.env'

# Step 4: Copy the .env file to the project directory
- script: cp -f $(envFile.secureFilePath) .env
  displayName: 'Copy Env File'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'  # Add your Laravel project path

# Step 5: Set up the environment and cache the configuration
- script: |
    php artisan key:generate
    php artisan config:cache
  displayName: 'Set up environment and cache configuration'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'

# Step 6: Run database migrations
- script: php artisan migrate --force
  displayName: 'Run database migrations'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'

# Step 7: Run Laravel PHPUnit tests
- script: php artisan test
  displayName: 'Run PHP Artisan Tests'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'

# Step 8: Install NPM dependencies
- script: npm install
  displayName: 'Install NPM Dependencies'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'

# Step 9: Run NPM production build
- script: npm run prod
  displayName: 'Run NPM Production Build'
  workingDirectory: '/home/azureuser/development_hosting/php/laravel/FirdausOrchestra'

# Step 10: Archive files
- task: ArchiveFiles@2
  displayName: 'Archive files'
  inputs:
    rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
    replaceExistingArchive: true

# Step 11: Publish build artifacts
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    artifactName: 'drop'
    targetPath: '$(Build.ArtifactStagingDirectory)'
